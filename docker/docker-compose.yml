version: "3.9"

services:
  register-blocks:
    image: ghcr.io/herugen/stevedore-downloader:latest
    build:
      context: ..
      dockerfile: docker/download-worker/Dockerfile
    command: python scripts/register_local_blocks.py
    environment:
      PREFECT_API_URL: http://host.docker.internal:4200/api
      COBALT_BASE_URL: http://host.docker.internal:9100
      MINIO_ENDPOINT: http://host.docker.internal:9100
      MINIO_BUCKET: stevedore
      MINIO_ACCESS_KEY: admin
      MINIO_SECRET_KEY: admin123
      #MINIO_PATH_PREFIX: downloads
    restart: "no"

  apply-deployment:
    image: ghcr.io/herugen/stevedore-downloader:latest
    build:
      context: ..
      dockerfile: docker/download-worker/Dockerfile
    command: python deployments/local_download_worker.py
    environment:
      PREFECT_API_URL: http://host.docker.internal:4200/api
    depends_on:
      register-blocks:
        condition: service_completed_successfully
    restart: "no"

  downloader:
    image: ghcr.io/herugen/stevedore-downloader:latest
    build:
      context: ..
      dockerfile: docker/download-worker/Dockerfile
    environment:
      PREFECT_API_URL: http://host.docker.internal:4200/api
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped

